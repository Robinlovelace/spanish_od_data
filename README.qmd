---
format: gfm
---

This repo demonstrates how to download and use OD data from Spain, published by [transportes.gob.es](https://www.transportes.gob.es/ministerio/proyectos-singulares/estudios-de-movilidad-con-big-data/opendata-movilidad)

The data is provided as follows:

- Estudios basicos
    - Por disitritos
      - Personas (population)
      - Pernoctaciones (overnight stays)
      - Viajes
        - ficheros-diarios
        - meses-completos

```{r}
#| label: installation
if (!requireNamespace("remotes", quietly = TRUE)) {
  install.packages("remotes")
}
remotes::install_cran("duckdb")
```

```{r}
#| label: pkgs
library(duckdb)
library(tidyverse)
```

## Zones

Zones can be downloaded as follows:

```{r}
#  zonificacion_distritos.cpg	2023-04-19 10:57:02	5 Bytes
# zonificacion_distritos.dbf	2023-04-19 10:57:02	309 KB
# zonificacion_distritos.prj	2023-04-19 10:57:02	393 Bytes
# zonificacion_distritos.qmd	2022-12-20 15:25:26	657 Bytes
# zonificacion_distritos.qpj	2023-04-19 10:57:02	618 Bytes
# zonificacion_distritos.shp	2023-04-19 10:57:02	22 MB
# zonificacion_distritos.shx
shp_extensions = c("cpg", "dbf", "prj", "qmd", "qpj", "shp", "shx")
base_url = "https://movilidad-opendata.mitma.es/zonificacion/zonificacion_distritos/zonificacion_distritos"
dir.create("zonificacion_distritos", showWarnings = FALSE)
for (ext in shp_extensions) {
  u = paste0(base_url, ".", ext)
  f = file.path("zonificacion_distritos", paste0("zonificacion_distritos.", ext))
  if (!file.exists(f)) {
    download.file(u, f)
  }
}
```

## Estudios basicos

Each day in the `ficheros-diarios` folder contains a file with the following columns:

```{r}
# set timeout for downloads
options(timeout = 600) # 10 minutes
u1 = "https://movilidad-opendata.mitma.es/estudios_basicos/por-distritos/viajes/ficheros-diarios/2024-03/20240301_Viajes_distritos.csv.gz"
f1 = basename(u1)
if (!file.exists(f1)) {
  download.file(u1, f1)
}

```




```{r}
#| eval: false
#| echo: false
#| label: repo-setup
# Create data-raw and data folders
usethis::use_data_raw()
```

```{r}
u = "https://movilidad-opendata.mitma.es/estudios_completos/por-distritos/movilidad_obligada/meses-completos/202201_Movilidad_obligada_distritos.csv.gz"
f = basename(u)
if (!file.exists(f)) {
  download.file(u, f)
}
drv = duckdb::duckdb("movilidad.duckdb")
con = DBI::dbConnect(drv)
od1 = duckdb::tbl_file(con, f)
od1_head = od1 |>
  head() |>
  collect()
# close connection:
DBI::dbDisconnect(con)
# # A tibble: 6 Ã— 8
#      mes origen destino  edad  sexo   residencia recurrencia personas
#    <dbl> <chr>  <chr>    <chr> <chr>  <chr>      <chr>          <dbl>
# 1 202201 01001  01002    NA    NA     01         1-2             4.41
# 2 202201 01001  01002    0-25  hombre 01         5-7            11   
# 3 202201 01001  01004_AM NA    NA     01         1-2             4.39
# 4 202201 01001  01009_AM 0-25  mujer  01         1-2           145.  
# 5 202201 01001  01009_AM 25-45 mujer  01         1-2           120.  
# 6 202201 01001  01009_AM 45-65 mujer  01         1-2           119.  
```

```{r}
#| label: od1_full
od1_full = od1 |>
  collect()
table(od1_full$recurrencia)
```


```{r}
od1_head |>
  knitr::kable()
```